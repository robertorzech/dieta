<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Dieta Respo">
<meta name="theme-color" content="#1b4332">
<title>Dieta Respo</title>
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231b4332' width='100' height='100' rx='20'/><text x='50' y='68' text-anchor='middle' font-size='52'>ü•ó</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'DM Sans',sans-serif;background:linear-gradient(180deg,#f5f7f2,#eef2e8);min-height:100vh;min-height:100dvh;overscroll-behavior:none}
button{font-family:'DM Sans',sans-serif;cursor:pointer;border:none;outline:none;-webkit-appearance:none}
::-webkit-scrollbar{display:none}

.app{max-width:480px;margin:0 auto;min-height:100vh;min-height:100dvh;position:relative}
.header{background:linear-gradient(135deg,#1b4332 0%,#2d6a4f 50%,#40916c 100%);padding:env(safe-area-inset-top,12px) 20px 24px;border-radius:0 0 28px 28px;box-shadow:0 4px 24px rgba(27,67,50,.25)}
.header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-top:12px}
.logo{font-family:'Playfair Display',serif;font-size:26px;color:#fff;font-weight:700;letter-spacing:-.5px}
.subtitle{font-size:12px;color:rgba(255,255,255,.7);margin-top:2px;letter-spacing:1px;text-transform:uppercase}
.nav-btns{display:flex;gap:4px;align-items:center}
.nav-btn{background:rgba(255,255,255,.15);border-radius:12px;width:36px;height:36px;color:#fff;font-size:18px;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
.today-btn{background:rgba(255,255,255,.15);border-radius:12px;padding:6px 12px;color:#fff;font-size:12px;font-weight:600;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
.days-row{display:flex;gap:4px;justify-content:space-between}
.day-btn{flex:1;border-radius:14px;padding:8px 2px 6px;display:flex;flex-direction:column;align-items:center;gap:2px;transition:all .2s;position:relative}
.day-btn.active{background:#fff;color:#1b4332;box-shadow:0 2px 12px rgba(0,0,0,.15)}
.day-btn:not(.active){background:rgba(255,255,255,.1);color:rgba(255,255,255,.85)}
.day-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.day-num{font-size:16px;font-weight:700}
.dots{display:flex;gap:2px;margin-top:2px}
.dot{width:4px;height:4px;border-radius:50%}
.today-dot{position:absolute;bottom:-2px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:#95d5b2}

.content{padding:12px 20px 120px}
.day-header{display:flex;justify-content:space-between;align-items:baseline;padding:16px 0 0}
.day-title{font-size:20px;font-weight:700;color:#1b4332}
.day-date{font-size:12px;color:#52796f}

.totals-bar{margin-top:10px;background:#fff;border-radius:16px;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 1px 8px rgba(0,0,0,.05)}
.total-kcal{text-align:center}
.total-kcal-num{font-size:20px;font-weight:700;color:#1b4332}
.total-kcal-label{font-size:10px;color:#74796f;font-weight:500}
.divider{width:1px;height:28px;background:#e8ede4}
.macro-pill{text-align:center}
.macro-pill-val{font-size:16px;font-weight:700}
.macro-pill-label{font-size:10px;color:#74796f;font-weight:600}
.meal-count{text-align:center}
.meal-count-val{font-size:14px;font-weight:700}
.meal-count-label{font-size:10px;color:#74796f}

.slots{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.slot{background:#fff;border-radius:18px;overflow:hidden;box-shadow:0 1px 8px rgba(0,0,0,.05);transition:all .2s;border:2px solid transparent}
.slot.filled{border-color:#b7e4c7}
.slot-header{padding:14px 16px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.slot-left{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
.slot-icon{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.slot-icon.empty{background:#f0f4ec}
.slot-icon.filled{background:linear-gradient(135deg,#d8f3dc,#b7e4c7)}
.slot-meta{font-size:11px;color:#74796f;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.slot-name{font-size:14px;font-weight:600;color:#1b4332;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.slot-empty{font-size:14px;color:#95a392;font-style:italic}
.slot-right{display:flex;align-items:center;gap:8px;flex-shrink:0}
.slot-kcal{font-size:13px;font-weight:700;color:#2d6a4f}
.slot-arrow{width:28px;height:28px;border-radius:8px;background:#f0f4ec;display:flex;align-items:center;justify-content:center;font-size:12px;color:#52796f;transition:transform .2s}
.slot-arrow.open{transform:rotate(180deg)}

.meal-list{border-top:1px solid #e8ede4;padding:8px;background:#fafcf8}
.meal-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:14px;cursor:pointer;margin-bottom:4px;transition:all .15s}
.meal-item.selected{background:linear-gradient(135deg,#d8f3dc,#b7e4c7)}
.meal-check{width:22px;height:22px;border-radius:7px;flex-shrink:0;border:2px solid #c8d5c0;display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff;transition:all .15s}
.meal-check.checked{border-color:#2d6a4f;background:#2d6a4f}
.meal-info{flex:1;min-width:0}
.meal-title{font-size:13px;font-weight:500;color:#344e41;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.meal-item.selected .meal-title{font-weight:700;color:#1b4332}
.meal-macros{font-size:11px;color:#74796f;margin-top:2px}
.detail-btn{background:rgba(45,106,79,.08);border-radius:8px;padding:4px 8px;font-size:16px;color:#2d6a4f;flex-shrink:0}

.water{background:linear-gradient(135deg,#d4e7fe,#e8f0fe);border-radius:16px;padding:14px 16px;display:flex;align-items:center;gap:12px;margin-top:10px}
.water-icon{font-size:22px}
.water-title{font-size:13px;font-weight:600;color:#1a4a7a}
.water-sub{font-size:12px;color:#4a7ab5}

.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:100;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.modal{background:#fff;border-radius:24px 24px 0 0;width:100%;max-width:480px;max-height:80vh;max-height:80dvh;overflow:auto;padding:24px 20px calc(40px + env(safe-area-inset-bottom,0px))}
.modal-handle{width:40px;height:4px;border-radius:2px;background:#d0d5cc;margin:0 auto 16px}
.modal-title{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:#1b4332;margin-bottom:4px}
.macro-tags{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.macro-tag{border-radius:10px;padding:6px 12px;display:flex;gap:4px;align-items:baseline}
.macro-tag-val{font-size:14px;font-weight:700}
.macro-tag-label{font-size:11px;opacity:.7}
.section-title{font-size:13px;font-weight:700;color:#1b4332;margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
.section-box{background:#f8faf6;border-radius:14px;padding:12px 14px;margin-bottom:16px;font-size:13px;line-height:1.8;color:#344e41}
.ingredient-line{display:flex;align-items:baseline;gap:8px}
.ingredient-dot{color:#2d6a4f;font-size:8px}
.close-btn{width:100%;margin-top:20px;padding:14px;background:linear-gradient(135deg,#1b4332,#2d6a4f);color:#fff;border-radius:14px;font-size:15px;font-weight:600}
</style>
</head>
<body>
<div class="app" id="app"></div>

<script>
const MEALS_DB = {
  posilek1: [
    { id:"p1_1", name:"Kanapki z jajkiem i hummusem", kcal:698, b:40, w:67, t:33, ingredients:"Chleb ≈ºytni razowy 90g, Hummus 50g, Jajka 4szt, Rukola 30g, Papryka czerwona 170g", steps:"Jajka gotuj na twardo ~8 min. Chleb posmaruj hummusem. U≈Ç√≥≈º sa≈Çatƒô, plastry jajka i paprykƒô." },
    { id:"p1_2", name:"Owsianka z mango oraz marakujƒÖ", kcal:707, b:36, w:98, t:22, ingredients:"P≈Çatki owsiane 40g, Mleko 1.5% 150g, Skyr waniliowy 225g, Mango 50g, Marakuja 3szt, Wi√≥rki kokosowe 24g", steps:"P≈Çatki zalej ciep≈Çym mlekiem na 10 min. Pokr√≥j owoce. Dodaj skyr, u≈Ç√≥≈º owoce, posyp wi√≥rkami." },
    { id:"p1_3", name:"Waniliowa owsianka z bananem oraz kiwi", kcal:695, b:44, w:90, t:21, ingredients:"Mleko 1.5% 125g, P≈Çatki owsiane 40g, Erytrol 5g, Wanilia 1.5g, Banan 120g, Kiwi 75g, Jogurt skyr 225g, Migda≈Çy 30g", steps:"Gotuj p≈Çatki z mlekiem. Dodaj erytrol, waniliƒô i skyr. Na wierzch u≈Ç√≥≈º migda≈Çy, banana i kiwi." },
    { id:"p1_4", name:"Shake snickers", kcal:719, b:43, w:67, t:32, ingredients:"Mleko 1.5% 375g, Od≈ºywka bia≈Çkowa 25g, Kakao 5g, L√≥d 20g, Mas≈Ço orzechowe 10g, Czekolada gorzka 30g, Orzechy w≈Çoskie 5g, P≈Çatki owsiane 40g", steps:"Zblenduj mleko, od≈ºywkƒô, kakao, l√≥d, mas≈Ço orzechowe, p≈Çatki. Oblej szklankƒô czekoladƒÖ. Wlej shake, posyp orzechami." },
    { id:"p1_5", name:"Tost z szynkƒÖ, serem i warzywami", kcal:690, b:42, w:75, t:24, ingredients:"Chleb ≈ºytni razowy 120g, Szynka z kurczaka 40g, Mozzarella 120g, Pomidor 160g, Rzodkiewka 60g, Szczypiorek 5g", steps:"Na pieczywie u≈Ç√≥≈º mozzarellƒô i szynkƒô. Zapiekaj 6 min w 180¬∞C. Dodaj pomidora, rzodkiewkƒô i szczypiorek." },
    { id:"p1_6", name:"Tosty francuskie z szynkƒÖ i warzywami", kcal:701, b:39, w:76, t:30, ingredients:"Jajko 56g, Mleko 30g, Chleb ≈ºytni razowy 120g, Oliwa 20g, Szynka z indyka 120g, Pomidor 160g, Og√≥rek 75g, Rzodkiewka 60g, Szczypiorek 15g", steps:"Jajko wymieszaj z mlekiem, solƒÖ i pieprzem. Namocz chleb i usma≈º na oliwie. U≈Ç√≥≈º wƒôdlinƒô i warzywa." },
    { id:"p1_7", name:"Kanapki z szynkƒÖ z indyka, hummusem i warzywami", kcal:707, b:49, w:86, t:23, ingredients:"Chleb ≈ºytni razowy 120g, Hummus 60g, Szynka z indyka 60g, Pomidor 160g, Og√≥rek 75g, Serek wiejski 200g", steps:"Na pieczywo na≈Ç√≥≈º hummus i szynkƒô. Pokr√≥j warzywa i u≈Ç√≥≈º na kanapce. Do posi≈Çku zjedz serek wiejski." }
  ],
  posilek2: [
    { id:"p2_1", name:"Kebab z grilla", kcal:806, b:44, w:93, t:28, ingredients:"Tortilla pe≈Çnoziarnista 2szt, Pier≈õ kurczaka 150g, Og√≥rek 150g, Papryka czerwona 170g, Miks sa≈Çat 50g, Ketchup 40g, Oliwa 12.5g, Sos BBQ 25g, Papryka wƒôdzona i ostra", steps:"Zamarynuj miƒôso (oliwa, sos BBQ, papryka). Grilluj 15 min. Pokr√≥j warzywa. U≈Ç√≥≈º na tortilli z sa≈ÇatƒÖ i ketchupem." },
    { id:"p2_2", name:"Makaron z indykiem i suszonymi pomidorami", kcal:808, b:46, w:77, t:33, ingredients:"Pier≈õ indyka 150g, Pomidory suszone 30g, Szpinak 25g, Cebula czerwona 40g, Czosnek 6g, Makaron pe≈Çnoziarnisty 100g, Oliwa 25g", steps:"Pokr√≥j miƒôso w paski. Ugotuj makaron. Podsma≈º cebulƒô, czosnek i pomidory. Dodaj miƒôso na 6-8 min, potem szpinak. Wymieszaj z makaronem." },
    { id:"p2_3", name:"Tortilla z kurczakiem", kcal:814, b:47, w:80, t:33, ingredients:"Pier≈õ kurczaka 150g, Przyprawa gyros, Oliwa 5g, Tortilla pe≈Çnoziarnista 2szt, Papryka 85g, Pomidor 160g, Og√≥rek 75g, Jogurt 80g, Majonez 15g, Czosnek 6g, Miks sa≈Çat 40g", steps:"Pokr√≥j kurczaka, posyp gyrosem. Sma≈º 6-8 min. Zr√≥b sos (jogurt + majonez + czosnek + cytryna). U≈Ç√≥≈º na tortilli z warzywami." },
    { id:"p2_4", name:"Pinsa z cukiniƒÖ oraz burratƒÖ", kcal:819, b:37, w:117, t:21, ingredients:"Pinsa 230g, Passata pomidorowa 100g, Bazylia suszona, Cukinia 150g, Szynka parme≈Ñska 45g, Burrata 40g", steps:"Nagrzej piekarnik do 250¬∞C. Pokr√≥j cukiniƒô. Posmaruj pinsƒô passatƒÖ, u≈Ç√≥≈º cukiniƒô. Zapiekaj 5 min, dodaj szynkƒô i burratƒô na 1 min." },
    { id:"p2_5", name:"Kurczak na parze z warzywami i ry≈ºem", kcal:787, b:42, w:84, t:33, ingredients:"Pier≈õ kurczaka 150g, Tymianek, Marchew 80g, Broku≈Ç 100g, Ry≈º bia≈Çy 90g, Oliwa 30g", steps:"Ugotuj ry≈º. Obsyp miƒôso tymiankiem. Gotuj na parze 20 min z warzywami. Podaj z oliwƒÖ." },
    { id:"p2_6", name:"Makaron z pieczarkami w sosie ≈õmietanowym", kcal:789, b:37, w:84, t:33, ingredients:"Makaron pe≈Çnoziarnisty 80g, Szpinak 75g, ≈ömietanka 12% 150g, Czosnek 6g, Cebula 65g, Pieczarki 200g, Grana Padano 20g, Broku≈Ç 200g, Pomidorki koktajlowe 100g, Oliwa 5g", steps:"Ugotuj makaron i broku≈Çy. Podsma≈º cebulƒô, czosnek i pieczarki. Wlej ≈õmietanƒô. Dodaj broku≈Çy, szpinak, pomidorki. Wymieszaj z makaronem, posyp serem." },
    { id:"p2_7", name:"Leczo z kurczakiem", kcal:785, b:41, w:89, t:31, ingredients:"Pier≈õ kurczaka 125g, Pomidory z puszki 300g, Koncentrat pomidorowy 25g, Papryka 170g, Cukinia 100g, Bazylia, Oliwa 25g, Ry≈º basmati 70g", steps:"Ugotuj ry≈º. Podsma≈º cukiniƒô i paprykƒô na oliwie. Dodaj pomidory z puszki. Du≈õ 10 min z bulionem. Dodaj kurczaka w kostkƒô na 15 min." }
  ],
  posilek3: [
    { id:"p3_1", name:"Kakaowa kokosanka", kcal:698, b:41, w:32, t:47, ingredients:"Mleczko kokosowe 12% 200g, Nasiona chia 10g, Siemiƒô lniane 10g, Wi√≥rki kokosowe 12g, Kakao 5g, Wanilia 1.5g, Jogurt skyr 75g, Migda≈Çy 10g, Bor√≥wki 50g, Od≈ºywka bia≈Çkowa 30g", steps:"W rondelku wymieszaj mleczko kokosowe z chia, siemieniem, wi√≥rkami, kakao, waniliƒÖ i od≈ºywkƒÖ. Zagotuj, gotuj 4 min. Podaj z jogurtem, owocami i migda≈Çami." },
    { id:"p3_2", name:"Kanapka z jajkiem", kcal:692, b:35, w:77, t:31, ingredients:"Chleb ≈ºytni razowy 120g, Serek ≈õmietankowy 50g, Jajka 3szt, Pomidor 160g, Rzodkiewka 90g, Rukola 50g, Szczypiorek 10g", steps:"Ugotuj jajka na twardo 8 min. Posmaruj chleb serkiem. U≈Ç√≥≈º rukolƒô, jajka, pomidora, rzodkiewkƒô. Posyp szczypiorkiem." },
    { id:"p3_3", name:"Koktajl malinowy", kcal:705, b:43, w:94, t:26, ingredients:"Maliny 400g, Mleko 1.5% 250g, Jogurt skyr 150g, Siemiƒô lniane 10g, Mas≈Ço orzechowe 30g, P≈Çatki owsiane 25g", steps:"Zblenduj wszystkie sk≈Çadniki. W razie potrzeby dodaj wody." },
    { id:"p3_4", name:"Tost z mozzarellƒÖ oraz szynkƒÖ z kurczaka", kcal:695, b:45, w:70, t:24, ingredients:"Chleb ≈ºytni razowy 120g, Mozzarella kulka 120g, Szynka z kurczaka 60g, Pomidorki koktajlowe 160g", steps:"Na chleb u≈Ç√≥≈º mozzarellƒô i szynkƒô. Podpiekaj na patelni 3 min pod przykryciem z ka≈ºdej strony. Podaj z pomidorkami." },
    { id:"p3_5", name:"Wiosenny serek wiejski z pieczywem", kcal:702, b:47, w:82, t:24, ingredients:"Serek wiejski 300g, Og√≥rek 75g, Papryka czerwona 85g, Rzodkiewka 60g, Szczypiorek 10g, Chleb ≈ºytni razowy 120g, Mas≈Ço extra 10g", steps:"Pokr√≥j warzywa i wymieszaj z serkiem. Podaj z pieczywem posmarowanym mas≈Çem." },
    { id:"p3_6", name:"Dutch baby z owocami", kcal:699, b:44, w:79, t:27, ingredients:"MƒÖka pe≈Çnoziarnista 60g, Mleko 1.5% 125g, Jajka 2szt, Erytrol 15g, Olej rzepakowy 5g, Wanilia, Jogurt skyr 120g, Mas≈Ço orzechowe 15g, Bor√≥wki 100g, Truskawki 50g", steps:"Nagrzej piekarnik do 210¬∞C z patelniƒÖ. Wymiksuj ciasto. Wlej na nat≈ÇuszczonƒÖ patelniƒô. Piecz 10 min. Na≈Ç√≥≈º skyr z mas≈Çem orzechowym i owoce." },
    { id:"p3_7", name:"Czekoladowe smoothie", kcal:661, b:43, w:71, t:25, ingredients:"Mleko ro≈õlinne 375g, Kakao 15g, Mas≈Ço orzechowe 25g, Erytrol 15g, Od≈ºywka bia≈Çkowa 40g, P≈Çatki owsiane 30g", steps:"Wszystkie sk≈Çadniki miksuj na g≈Çadkie smoothie. Dolej wody w razie potrzeby." }
  ],
  przekaska: [
    { id:"pk_1", name:"Gruszka", kcal:203, b:2, w:50, t:1, ingredients:"Gruszka ‚Äì 2 sztuki (350g)", steps:"Zjedz jako przekƒÖskƒô." },
    { id:"pk_2", name:"Mieszanka orzech√≥w", kcal:212, b:7, w:8, t:19, ingredients:"Mieszanka orzech√≥w ‚Äì 35g", steps:"Zjedz orzechy jako przekƒÖskƒô." },
    { id:"pk_3", name:"Banan", kcal:194, b:2, w:47, t:1, ingredients:"Banan ‚Äì 200g", steps:"Zjedz jako przekƒÖskƒô." },
    { id:"pk_4", name:"Pudding proteinowy Valio + owoce", kcal:193, b:20, w:21, t:3, ingredients:"Pudding proteinowy czekoladowy Valio 180g, Kiwi 75g", steps:"Zjedz pudding z owocami jako przekƒÖskƒô." },
    { id:"pk_5", name:"Owsianka Lubella + orzechy", kcal:190, b:6, w:21, t:10, ingredients:"Owsianka Lubella z bananami i kakao 100g, Orzechy nerkowca 20g", steps:"Zjedz owsiankƒô z orzechami jako przekƒÖskƒô." },
    { id:"pk_6", name:"Owolowo tropikalnie + orzechy", kcal:192, b:3, w:23, t:9, ingredients:"Owolowo tropikalnie 200g, Orzechy w≈Çoskie 15g", steps:"Zjedz mus z orzechami jako przekƒÖskƒô." },
    { id:"pk_7", name:"Pieczona marchew z mas≈Çem orzechowym", kcal:201, b:6, w:13, t:16, ingredients:"Marchew 80g, Papryka ostra, Imbir, Kumin, Mas≈Ço orzechowe 15g, Oliwa 5g, Sezam 2.5g", steps:"Pokr√≥j marchew w s≈Çupki. Przygotuj sos (mas≈Ço orzechowe, imbir, oliwa, papryka, kumin). Piecz w 180¬∞C przez 25 min." }
  ]
};

const SLOTS = [
  { key:"posilek1", label:"Posi≈Çek 1", time:"7:00‚Äì10:00", icon:"‚òÄÔ∏è" },
  { key:"posilek2", label:"Posi≈Çek 2", time:"12:00‚Äì15:00", icon:"üçΩÔ∏è" },
  { key:"posilek3", label:"Posi≈Çek 3", time:"17:00‚Äì20:00", icon:"üåô" },
  { key:"przekaska", label:"PrzekƒÖska", time:"dowolna pora", icon:"üçé" }
];

const DAYS = ["Pon","Wt","≈ör","Czw","Pt","Sob","Ndz"];
const FULL_DAYS = ["Poniedzia≈Çek","Wtorek","≈öroda","Czwartek","PiƒÖtek","Sobota","Niedziela"];
const STORAGE_KEY = "respo-meal-plan-v2";

let state = {
  plan: JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"),
  weekOffset: 0,
  selectedDay: (new Date().getDay() + 6) % 7,
  expandedSlot: null,
  detailMeal: null
};

function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state.plan)); }

function getMonday(offset) {
  const d = new Date();
  const day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1) + offset * 7;
  d.setDate(diff); d.setHours(0,0,0,0);
  return d;
}

function getWeekId(mon) {
  const d = new Date(mon);
  d.setDate(d.getDate() + 3 - ((d.getDay() + 6) % 7));
  const w1 = new Date(d.getFullYear(), 0, 4);
  return `${d.getFullYear()}-W${String(Math.round(((d - w1) / 864e5 - 3 + ((w1.getDay() + 6) % 7)) / 7) + 1).padStart(2,"0")}`;
}

function weekDates(mon) {
  return Array.from({length:7}, (_,i) => { const d = new Date(mon); d.setDate(d.getDate()+i); return d; });
}

function isToday(d) { return d.toDateString() === new Date().toDateString(); }

function getKey(weekId, dayIdx, slot) { return `${weekId}_${dayIdx}_${slot}`; }

function getMeal(slot, id) { return MEALS_DB[slot]?.find(m => m.id === id) || null; }

function getDayTotals(weekId, dayIdx) {
  let kcal=0, b=0, w=0, t=0, count=0;
  for (const s of SLOTS) {
    const sel = state.plan[getKey(weekId, dayIdx, s.key)];
    if (sel) { const m = getMeal(s.key, sel); if(m){kcal+=m.kcal;b+=m.b;w+=m.w;t+=m.t;count++;} }
  }
  return {kcal,b,w,t,count};
}

function render() {
  const mon = getMonday(state.weekOffset);
  const wid = getWeekId(mon);
  const dates = weekDates(mon);
  const totals = getDayTotals(wid, state.selectedDay);
  const app = document.getElementById("app");

  let html = `
  <div class="header">
    <div class="header-top">
      <div>
        <div class="logo">M√≥j Plan</div>
        <div class="subtitle">~2400 kcal ¬∑ Redukcja</div>
      </div>
      <div class="nav-btns">
        <button class="nav-btn" onclick="prevWeek()">‚Äπ</button>
        <button class="today-btn" onclick="goToday()">Dzi≈õ</button>
        <button class="nav-btn" onclick="nextWeek()">‚Ä∫</button>
      </div>
    </div>
    <div class="days-row">`;

  DAYS.forEach((day, idx) => {
    const active = state.selectedDay === idx;
    const td = isToday(dates[idx]);
    const dt = getDayTotals(wid, idx);
    html += `<button class="day-btn${active?" active":""}" onclick="selectDay(${idx})">
      <span class="day-label">${day}</span>
      <span class="day-num">${dates[idx].getDate()}</span>
      <div class="dots">
        ${[0,1,2,3].map(i => `<div class="dot" style="background:${i<dt.count?(active?"#2d6a4f":"rgba(255,255,255,.9)"):(active?"rgba(45,106,79,.2)":"rgba(255,255,255,.2)")}"></div>`).join("")}
      </div>
      ${td && !active ? '<div class="today-dot"></div>' : ''}
    </button>`;
  });

  html += `</div></div>
  <div class="day-header" style="padding:16px 20px 0">
    <div class="day-title">${FULL_DAYS[state.selectedDay]}</div>
    <div class="day-date">${dates[state.selectedDay].toLocaleDateString("pl-PL",{day:"numeric",month:"short"})}</div>
  </div>`;

  if (totals.count > 0) {
    html += `<div style="padding:0 20px"><div class="totals-bar">
      <div class="total-kcal"><div class="total-kcal-num">${totals.kcal}</div><div class="total-kcal-label">kcal</div></div>
      <div class="divider"></div>
      <div class="macro-pill"><div class="macro-pill-val" style="color:#2d6a4f">${totals.b}g</div><div class="macro-pill-label">B</div></div>
      <div class="divider"></div>
      <div class="macro-pill"><div class="macro-pill-val" style="color:#d4a017">${totals.w}g</div><div class="macro-pill-label">W</div></div>
      <div class="divider"></div>
      <div class="macro-pill"><div class="macro-pill-val" style="color:#c44536">${totals.t}g</div><div class="macro-pill-label">T</div></div>
      <div class="divider"></div>
      <div class="meal-count"><div class="meal-count-val" style="color:${totals.count===4?"#2d6a4f":"#95a392"}">${totals.count}/4</div><div class="meal-count-label">posi≈Çki</div></div>
    </div></div>`;
  }

  html += `<div class="content"><div class="slots">`;

  SLOTS.forEach(slot => {
    const selId = state.plan[getKey(wid, state.selectedDay, slot.key)];
    const meal = selId ? getMeal(slot.key, selId) : null;
    const expanded = state.expandedSlot === `${state.selectedDay}_${slot.key}`;

    html += `<div class="slot${meal?" filled":""}">
      <div class="slot-header" onclick="toggleSlot('${state.selectedDay}_${slot.key}')">
        <div class="slot-left">
          <div class="slot-icon ${meal?"filled":"empty"}">${meal?"‚úì":slot.icon}</div>
          <div style="min-width:0">
            <div class="slot-meta">${slot.label} ¬∑ ${slot.time}</div>
            ${meal?`<div class="slot-name">${meal.name}</div>`:'<div class="slot-empty">Wybierz posi≈Çek...</div>'}
          </div>
        </div>
        <div class="slot-right">
          ${meal?`<div class="slot-kcal">${meal.kcal}</div>`:""}
          <div class="slot-arrow${expanded?" open":""}">‚ñæ</div>
        </div>
      </div>`;

    if (expanded) {
      html += `<div class="meal-list">`;
      MEALS_DB[slot.key].forEach(m => {
        const isSel = selId === m.id;
        html += `<div class="meal-item${isSel?" selected":""}" onclick="pickMeal('${wid}',${state.selectedDay},'${slot.key}','${m.id}',${isSel})">
          <div class="meal-check${isSel?" checked":""}">${isSel?"‚úì":""}</div>
          <div class="meal-info">
            <div class="meal-title">${m.name}</div>
            <div class="meal-macros">${m.kcal} kcal ¬∑ B:${m.b}g ¬∑ W:${m.w}g ¬∑ T:${m.t}g</div>
          </div>
          <button class="detail-btn" onclick="event.stopPropagation();showDetail('${slot.key}','${m.id}')">üìã</button>
        </div>`;
      });
      html += `</div>`;
    }

    html += `</div>`;
  });

  html += `</div>
  <div class="water">
    <div class="water-icon">üíß</div>
    <div><div class="water-title">Pamiƒôtaj o wodzie!</div><div class="water-sub">Min. 2.8 litra dziennie</div></div>
  </div></div>`;

  // Modal
  if (state.detailMeal) {
    const dm = state.detailMeal;
    const ings = dm.ingredients.split(", ");
    html += `<div class="modal-overlay" onclick="closeDetail()">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-handle"></div>
        <div class="modal-title">${dm.name}</div>
        <div class="macro-tags">
          <div class="macro-tag" style="background:#f0f4ec"><span class="macro-tag-val" style="color:#1b4332">${dm.kcal}</span><span class="macro-tag-label" style="color:#1b4332"> kcal</span></div>
          <div class="macro-tag" style="background:#d8f3dc"><span class="macro-tag-val" style="color:#2d6a4f">${dm.b}g</span><span class="macro-tag-label" style="color:#2d6a4f"> Bia≈Çko</span></div>
          <div class="macro-tag" style="background:#fff3cd"><span class="macro-tag-val" style="color:#856404">${dm.w}g</span><span class="macro-tag-label" style="color:#856404"> Wƒôgle</span></div>
          <div class="macro-tag" style="background:#fde8e4"><span class="macro-tag-val" style="color:#c44536">${dm.t}g</span><span class="macro-tag-label" style="color:#c44536"> T≈Çuszcz</span></div>
        </div>
        <div class="section-title">Sk≈Çadniki</div>
        <div class="section-box">${ings.map(i=>`<div class="ingredient-line"><span class="ingredient-dot">‚óè</span> ${i}</div>`).join("")}</div>
        <div class="section-title">Przygotowanie</div>
        <div class="section-box">${dm.steps}</div>
        <button class="close-btn" onclick="closeDetail()">Zamknij</button>
      </div>
    </div>`;
  }

  app.innerHTML = html;
}

function prevWeek() { state.weekOffset--; render(); }
function nextWeek() { state.weekOffset++; render(); }
function goToday() { state.weekOffset=0; state.selectedDay=(new Date().getDay()+6)%7; render(); }
function selectDay(i) { state.selectedDay=i; state.expandedSlot=null; render(); }
function toggleSlot(id) { state.expandedSlot = state.expandedSlot===id ? null : id; render(); }

function pickMeal(wid, dayIdx, slot, mealId, wasSel) {
  const key = getKey(wid, dayIdx, slot);
  if (wasSel) { delete state.plan[key]; } else { state.plan[key] = mealId; }
  state.expandedSlot = null;
  save(); render();
}

function showDetail(slot, id) { state.detailMeal = getMeal(slot, id); render(); }
function closeDetail() { state.detailMeal = null; render(); }

render();
</script>
</body>
</html>
